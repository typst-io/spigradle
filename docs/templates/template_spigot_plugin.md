# Spigot plugin

kdoc(
javadoc): [SpigotPlugin.kt](https://docs.typst.io/spigradle/$SPIGRADLE_VERSION/spigradle/io.typst.spigradle.spigot/-spigot-plugin/index.html)

The [Spigot](https://www.spigotmc.org/wiki/about-spigot/) plugin provides the following features:

- Generate 'plugin.yml' with the main detected automatically

- Debug feature: task `debug\$ProjectName`, idea Run Configuration `Debug\$ProjectName`/`Run\$ProjectName`

- Shortcuts for [dependency](../README.md#dependencies) and [repository](../README.md#repositories).

## Table of contents

- [Requirements](#requirements)

- [Usage](#usage)

- [Description file generation](#description-file-generation)

- [Main class detection](#main-class-detection)

- [Configuration](#configuration)

- [Use external dependencies](#use-external-dependencies)

- [Tasks](#tasks)

- [Why not spigot-annotations?](#why-not-spigot-annotations)

- [Testing with MockBukkit](#testing-with-mockbukkit)

- [Migration Tips](#migration-tips)

- [Templates](#templates)

- [See also](#see-also)

## Requirements

The plugin requires Gradle 8.0+, the latest version is recommended.

To update your gradle wrapper:

```
gradlew wrapper --gradle-version $GRADLE_VERSION --distribution-type all
```

## Usage

[Full Example Here](https://github.com/spigradle/spigradle-sample/tree/master/spigot)
### Using Version Catalog (Recommended)

**settings.gradle.kts**
```kotlin
dependencyResolutionManagement {
    repositories {
        mavenCentral()
    }
    versionCatalogs {
        create("spigots") {
            from("io.typst:spigot-catalog:$SPIGRADLE_VERSION")
        }
        create("commons") {
            from("io.typst:common-catalog:$SPIGRADLE_VERSION")
        }
    }
}
```

**build.gradle.kts**
```kotlin
plugins {
    java
    alias(spigots.plugins.spigot)
    alias(commons.plugins.ideaExt) // optional, for debug Run Configurations
}

repositories {
    mavenCentral()
    spigotRepos {
        papermc()
    }
}

dependencies {
    compileOnly(spigots.paper.api)
}
```

<details>
<summary>Groovy (settings.gradle)</summary>

```groovy
dependencyResolutionManagement {
    repositories {
        mavenCentral()
    }
    versionCatalogs {
        create('spigots') {
            from('io.typst:spigot-catalog:$SPIGRADLE_VERSION')
        }
        create('commons') {
            from('io.typst:common-catalog:$SPIGRADLE_VERSION')
        }
    }
}
```

</details>

<details>
<summary>Groovy (build.gradle)</summary>

```groovy
plugins {
    id 'java'
    alias spigots.plugins.spigot
    alias commons.plugins.ideaExt // optional
}

repositories {
    mavenCentral()
    spigotRepos {
        papermc()
    }
}

dependencies {
    compileOnly spigots.paper.api
}
```

</details>

### Without Version Catalog

**Groovy DSL**
```groovy
plugins {
    id 'io.typst.spigradle.spigot' version '$SPIGRADLE_VERSION'
    id 'org.jetbrains.gradle.plugin.idea-ext' version '$IDEA_EXT_VERSION' // optional
}
```

**Kotlin DSL**
```kotlin
plugins {
    id("io.typst.spigradle.spigot") version "$SPIGRADLE_VERSION"
    id("org.jetbrains.gradle.plugin.idea-ext") version "$IDEA_EXT_VERSION" // optional
}
```

## Description file generation

The `plugin.yml` file will be generated by task `generateSpigotDescription` based on the [configuration of
`spigot`](#configuration), included into output jars automatically.

Basically the properties 'main', 'name' and 'version' defaults
to [auto-detected main](#main-class-detection), [project.name](https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html#getName--), [project.version](https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html#getName--)
respectively. So if we create a simple plugin that just needs those properties, we don't need any configuration. Only
pay attention to your unique implementation.

You can configure all properties of `plugin.yml` in [spigot {} block](#configuration).

## Main class detection

The plugin automatically detects your main plugin class using bytecode analysis (ASM). It scans compiled `.class` files
to find classes that
extend [JavaPlugin](https://hub.spigotmc.org/javadocs/bukkit/org/bukkit/plugin/java/JavaPlugin.html).

**How it works:**

- Scans compiled bytecode (not source code) for faster and more reliable detection
- Finds non-abstract, public classes extending `org.bukkit.plugin.java.JavaPlugin`
- Supports complex inheritance hierarchies
- Incremental: only scans changed files for faster builds
- Automatically sets the `main` property in `plugin.yml`

**Manual override:**
If you need to manually specify the main class:

```groovy
spigot {
    main.set("com.example.MyCustomMain")
}
```

For more details, see the [Main Class Detection](../README.md#main-class-detection) section.

## Configuration

### spigot extension - [SpigotExtension](https://docs.typst.io/spigradle/$SPIGRADLE_VERSION/spigradle/io.typst.spigradle.spigot/-spigot-extension/index.html)

The description of your plugin for a `plugin.yml`.

The 'main' property will be set to the class [auto-detected](#main-class-detection)

About the `plugin.yml`, See [plugin-yml wiki](https://www.spigotmc.org/wiki/plugin-yml/)

<details>
<summary>Groovy Example</summary>

```groovy
spigot {
    authors = ['Me']
    depend = ['ProtocolLib', 'Vault']
    softDepend = ['WorldEdit']
    apiVersion = '1.15'
    load = "STARTUP"
    libraries = ['my:lib:1.0.0', 'my:lib2:1.0.0']
    commands {
        register('give') {
            aliases = ['giv', 'i']
            description = 'Give command.'
            permission = 'test.foo'
            permissionMessage = 'You do not have the permission!'
            usage = '/<command> [item] [amount]'
        }
    }
    permissions {
        register('test.foo') {
            description = 'Allows foo command'
            defaults = 'true'
        }
        register('test.*') {
            description = 'Wildcard permission'
            defaults = 'op'
            children = ['test.foo': true]
        }
    }
}
```

</details>

<details>
<summary>Kotlin Example</summary>

```kotlin
spigot {
    authors = listOf("Me")
    depend = listOf("ProtocolLib")
    softDepend = listOf("WorldEdit")
    apiVersion = "1.15"
    load = "STARTUP"
    commands {
        register("give") {
            aliases = listOf("i")
            description = "Give command."
            permission = "test.foo"
            permissionMessage = "You do not have permission!"
            usage = "/<command> [test|stop]"
        }
    }
    permissions {
        register("test.foo") {
            description = "Allows foo command"
            defaults = "true"
        }
        register("test.*") {
            description = "Wildcard permission"
            defaults = "op"
            children = mapOf("test.foo" to true)
        }
    }
}
```

Without [type-safe accessors](https://docs.gradle.org/current/userguide/kotlin_dsl.html#sec:kotlin_using_standard_api):

```kotlin
configure<SpigotExtension> {
    authors = listOf("Me")
    // ...
}
```

</details>

### debugSpigot extension - [DebugExtension](https://docs.typst.io/spigradle/$SPIGRADLE_VERSION/spigradle/io.typst.spigradle.debug/-debug-extension/index.html)

> **Note:** `debugSpigot` is a configuration extension, NOT a task. The actual task is named `debug\${ProjectName}` (
> e.g., `debugMyPlugin`).

**Available properties:**

| Property             | Type                            | Default                     | Description                                          |
|----------------------|---------------------------------|-----------------------------|------------------------------------------------------|
| `version`            | `Property<String>`              | -                           | Paper/Minecraft version to download (e.g., "1.21.8") |
| `eula`               | `Property<Boolean>`             | `false`                     | Auto-accept Minecraft EULA                           |
| `jvmDebugPort`       | `Property<Int>`                 | `5005`                      | Port for remote JVM debugging                        |
| `downloadSoftDepend` | `Property<Boolean>`             | `false`                     | Also download `softDepends` plugins                  |
| `jvmArgs`            | `ListProperty<String>`          | platform defaults           | JVM arguments (e.g., `-Xmx2G`)                       |
| `programArgs`        | `ListProperty<String>`          | platform defaults           | Server program arguments (e.g., `nogui`)             |
| `javaVersion`        | `Property<JavaLanguageVersion>` | project toolchain           | Java version for the server                          |
| `javaHome`           | `Property<Directory>`           | resolved from `javaVersion` | Java installation directory                          |

**Example:**

```groovy
debugSpigot {
    version = "1.21.8"
    eula = true
    jvmDebugPort = 5005
    downloadSoftDepend = true
    // Use append() (Gradle 8.7+) to preserve defaults:
    jvmArgs.append("-Xmx4G")
    programArgs.append("--world myworld")
}
```

```kotlin
debugSpigot {
    version = "1.21.8"
    eula = true
    jvmDebugPort = 5005
    downloadSoftDepend = true
    // Use append() (Gradle 8.7+) to preserve defaults:
    jvmArgs.append("-Xmx4G")
    programArgs.append("--world myworld")
}
```

> **Warning:** Using `add()`, `set()`, or `empty()` on `jvmArgs`/`programArgs` will discard platform defaults. Use
`append()` or `appendAll()` (Gradle 8.7+) to preserve defaults.

## Use external dependencies

Declaring dependencies to `libraries` in `plugin.yml` is the recommended approach instead of shading jar.

```kotlin
// Declare the dependencies here
val libs = listOf(
    "org.ahocorasick:ahocorasick:0.6.3",
)

dependencies {
    compileOnly(libs)
}

spigot {
    // ...
    libraries = libs
}
```

## Tasks

All tasks
supports [UP-TO-DATE check](https://docs.gradle.org/current/userguide/more_about_tasks.html#sec:up_to_date_checks).

### detectSpigotMain - [SubclassDetection](https://docs.typst.io/spigradle/$SPIGRADLE_VERSION/spigradle/io.typst.spigradle/-subclass-detection/index.html)

Finds the main class
extends [org.bukkit.plugin.java.JavaPlugin](https://hub.spigotmc.org/javadocs/bukkit/org/bukkit/plugin/java/JavaPlugin.html).

### generateSpigotDescription - [YamlGenerate](https://docs.typst.io/spigradle/$SPIGRADLE_VERSION/spigradle/io.typst.spigradle/-yaml-generate/index.html)

*Depends on: `detectSpigotMain`*

Generates the description file 'plugin.yml'.

### `debugProjectName` - [Exec](https://docs.gradle.org/current/javadoc/org/gradle/api/DefaultTask.html)

*Depends on: `prepareProjectName`*

Runs a local Paper server with your plugin for debugging. This task orchestrates the complete debug workflow:

**What it does:**

1. **Downloads Paper server** (via `downloadPaper`) - Fetches the specified Paper version from PaperMC API if not
   already cached
2. **Prepares plugin dependencies** (via `preparePluginDependencies`) - Resolves plugins listed in `depends`/
   `softDepends`:

- First tries to copy from your project's `compileClasspath`
- Falls back to downloading from SpigotMC (via Spiget API) if not found

3. **Copies your plugin JAR** (via `copyArtifactJar`) - Copies the built plugin to the debug server's plugins folder
4. **Creates starter scripts** (via `createJavaDebugScript`) - Generates platform-specific scripts:

- `starter.bat` for Windows
- `starter` for Unix/Linux/Mac

5. **Launches the server** - Opens a new terminal window and runs the server

**IntelliJ IDEA Run Configurations:**

Spigradle automatically creates two run configurations (NOTE: These are only generated if the plugin
`org.jetbrains.gradle.plugin.idea-ext` is applied):

1. **`Debug\${ProjectName}` - Remote JVM Debug** ‚≠ê **Recommended**
  - **Type:** Remote JVM Debug configuration
  - **Purpose:** Attaches debugger to an already-running server process
  - **Recommended workflow:**
    1. Run `debug\${ProjectName}` task via IntelliJ's terminal or "Run Gradle Task"
    2. Server starts in a new terminal window with remote debugging enabled on port 5005
    3. Click the "üêû Debug" button on this configuration to attach the debugger
  - **Advantages:**
    - **Keeps IntelliJ lightweight** - server runs in separate terminal, not managed by IDE
    - Clean separation between server output and IDE
    - Better performance - IDE doesn't handle server I/O
  - **When to use:** Standard debugging workflow (recommended for regular use)

2. **`Run\${ProjectName}` - JarApplication**
  - **Type:** JarApplication run configuration
  - **Purpose:** All-in-one server launch directly from IntelliJ
  - **Usage:**
    - Click the "‚ñ∂ Run" button to start the server normally
    - Click the "üêû Debug" button to start the server AND attach debugger in one step
  - **Note:** Makes IntelliJ heavier as it manages the server process directly; You need to click the
    `Sync All Gradle Projects` button in IDEA if you change the debugSpigot extension.
  - **When to use:** Only when you want absolute convenience and don't mind the performance impact

**Directory structure:**

- Server directory: `MY_PROJECT/.gradle/spigradle-debug/paper/`
- Global JAR cache: `GRADLE_USER_HOME/spigradle-debug-jars/paper/VERSION/paper.jar`
- Plugin dependencies: `MY_PROJECT/.gradle/spigradle-debug/paper/plugins/`

**Configuration:**

See [debugSpigot extension](#debugspigot-extension---debugextension) for configuration options like version, EULA
acceptance, JVM arguments, and debug port.

## Why not spigot-annotations?

```kotlin
@Plugin(name = "SamplePlugin", version = "1.0-SNAPSHOT")
@Commands(
    @Command(
        name = "foo",
        desc = "Foo command",
        aliases = ["foobar", "fubar"],
        permission = "test.foo",
        permissionMessage = "You do not have permission!",
        usage = "/<command> [test|stop]"
    )
)
@Permission(name = "test.foo", desc = "Allows foo command", defaultValue = PermissionDefault.OP)
class SamplePlugin : JavaPlugin()
```

If you use Gradle, the following reasons why
no [spigot-annotations](https://hub.spigotmc.org/stash/projects/SPIGOT/repos/plugin-annotations/browse):

1. Duplicate information of the `name` and `version`, these already provided in `build.gradle` and `settings.gradle`.
2. The Annotation doesn't suit for providing complex information like `commands` and `permissions`.
3. Using Gradle, we can configure all things programmatically.

Replacement on build.gradle:

```groovy
spigot {
    // The 'name' and 'version' will be set to project.version and project.name,
    // But we may set those manually for the example
    name.set('Manual name')
    version.set('Manual version')
    commands {
        register('foo') {
            aliases = ['foobar', 'fubar']
            description = 'Foo command'
            permission = 'test.foo'
            permissionMessage = 'You do not have permission!'
            usage = '/<command> [test|stop]'
        }
    }
    permissions {
        register('test.foo') {
            description = 'Allows foo command'
            defaults = 'op'
        }
    }
}
```

## Testing with MockBukkit

With Spigradle 1.3.0+, you can use the [MockBukkit](https://github.com/seeseemelk/MockBukkit) without any special code.

If you use less than 1.3.0, add it in build.gradle:

```groovy
task copyPluginYaml(type: Copy, dependsOn: spigotPluginYaml) {
    from(new File(spigotPluginYaml.temporaryDir, 'plugin.yml'))
    into(sourceSets.test.output.resourcesDir)
}

tasks.test.dependsOn(copyPluginYaml)
```

## Migration Tips

### 3.x <- 2.x

- The groupId has been changed from `kr.entree.spigradle` to `io.typst.spigradle`.
- No more implicit repo/dep: need to declare repository(spigotmc)
- No more @Plugin annotation: the main class will be detected automatically.
- The Gradle version must be 8.x or higher (ex: 8.14.3)
  - If you use gradle wrapper, edit the `distributionUrl` in `gradle/wrapper/gradle-wrapper.properties` ex)
    `gradle-8.14.3-all.zip`
- The Gradle JVM version must be 17 or higher.
- The options `main`, `name`, `version`, `description` are changed type Property<String> from String
  - Configuration example: `spigot { description.set("my description") }`

![img.png](./../assets/idea-gradle-jvm.png)

### 2.x <- 1.x

- The task `spigotPluginYaml` renamed to `generateSpigotDescription`
- The annotation `@Plugin` repackaged to `@io.typst.spigradle.annotations.Plugin`.

## Templates

[spigot-plugin-template](https://github.com/Silthus/spigot-plugin-template) by @Silthus

[BukkitJavaGradle](https://github.com/PluginTemplates/BukkitJavaGradle) by @portlek

## See also

- [The Bungeecord plugin](bungeecord_plugin.md)
- [The Nukkit plugin](nukkit_plugin.md)
- [README.md](../README.md)
- [Gradle Kotlin DSL Primer](https://docs.gradle.org/current/userguide/kotlin_dsl.html)
