# Multi-Module Projects

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Spigradle supports Gradle multi-module projects, allowing you to organize your plugin code into multiple modules with shared dependencies and platform-specific implementations.

## Table of contents

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

- [Why Multi-Module?](#why-multi-module)
- [Requirements](#requirements)
- [Project Structure](#project-structure)
- [Setup Guide](#setup-guide)
  - [Step 1: Configure settings.gradle](#step-1-configure-settingsgradle)
  - [Step 2: Configure root build.gradle](#step-2-configure-root-buildgradle)
  - [Step 3: Configure subproject build.gradle](#step-3-configure-subproject-buildgradle)
- [Common Patterns](#common-patterns)
  - [Common/Shared Module](#commonshared-module)
  - [Platform-Specific Modules](#platform-specific-modules)
  - [API Module](#api-module)
- [Complete Examples](#complete-examples)
- [Dependency Management](#dependency-management)
- [Building Multi-Module Projects](#building-multi-module-projects)
- [Best Practices](#best-practices)
- [Troubleshooting](#troubleshooting)
- [See also](#see-also)

## Why Multi-Module?

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Multi-module projects offer several benefits for Minecraft plugin development:

- **Code Reuse**: Share common code across multiple platform implementations (Spigot, BungeeCord, NukkitX)
- **Separation of Concerns**: Isolate platform-specific code from business logic
- **API/Implementation Split**: Expose a public API while keeping implementation details private
- **Better Organization**: Manage large codebases with clear module boundaries
- **Independent Versioning**: Version modules independently if needed
- **Cleaner Dependencies**: Each module declares only the dependencies it needs

**Common use cases:**
- Cross-platform plugins (Spigot + BungeeCord + Velocity)
- Plugin suite with shared utilities
- Plugin with public API for developers
- Large plugins split into feature modules

## Requirements

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

- Gradle 8.0+ (the latest version is recommended)
- Spigradle 3.5.0 or higher
- Basic understanding of Gradle multi-module projects

To update your gradle wrapper:

```bash
gradlew wrapper --gradle-version 8.14.3 --distribution-type all
```

## Project Structure

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

A typical multi-module Spigradle project structure:

```
my-plugin/
├── settings.gradle                # Declares all modules
├── build.gradle                   # Root build configuration
├── gradle.properties              # Shared properties
├── common/                        # Shared code module
│   ├── build.gradle
│   └── src/main/java/...
├── spigot/                        # Spigot implementation
│   ├── build.gradle
│   └── src/main/java/...
├── bungee/                        # BungeeCord implementation
│   ├── build.gradle
│   └── src/main/java/...
└── api/                           # Public API (optional)
    ├── build.gradle
    └── src/main/java/...
```

## Setup Guide

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

### Step 1: Configure settings.gradle

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Define all modules in your project:

**Groovy DSL:**
```groovy
rootProject.name = 'my-plugin'

include 'common'
include 'spigot'
include 'bungee'
include 'api'  // optional
```

**Kotlin DSL (`settings.gradle.kts`):**
```kotlin
rootProject.name = "my-plugin"

include("common")
include("spigot")
include("bungee")
include("api")  // optional
```

### Step 2: Configure root build.gradle

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Configure shared settings for all subprojects:

<details>
<summary>Groovy DSL</summary>

```groovy
plugins {
    id 'java'
}

// Apply to all subprojects
subprojects {
    apply plugin: 'java'

    group = 'com.example.myplugin'
    version = '1.0.0'

    repositories {
        mavenCentral()
    }

    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(17)
        }
    }

    tasks.withType(JavaCompile) {
        options.encoding = 'UTF-8'
    }
}
```

</details>

<details>
<summary>Kotlin DSL (build.gradle.kts)</summary>

```kotlin
plugins {
    java
}

subprojects {
    apply(plugin = "java")

    group = "com.example.myplugin"
    version = "1.0.0"

    repositories {
        mavenCentral()
    }

    java {
        toolchain {
            languageVersion.set(JavaLanguageVersion.of(17))
        }
    }

    tasks.withType<JavaCompile> {
        options.encoding = "UTF-8"
    }
}
```

</details>

### Step 3: Configure subproject build.gradle

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

#### Common module (common/build.gradle)

The common module contains shared code and has no platform-specific dependencies.

<details>
<summary>Groovy DSL</summary>

```groovy
// No Spigradle plugin needed for common module
dependencies {
    // Add common dependencies here
    compileOnly 'org.jetbrains:annotations:24.0.1'
}
```

</details>

<details>
<summary>Kotlin DSL</summary>

```kotlin
// No Spigradle plugin needed for common module
dependencies {
    // Add common dependencies here
    compileOnly("org.jetbrains:annotations:24.0.1")
}
```

</details>

#### Spigot module (spigot/build.gradle)

<details>
<summary>Groovy DSL</summary>

```groovy
plugins {
    id 'io.typst.spigradle' version '3.5.0'
}

repositories {
    spigotmc()
    papermc()
}

dependencies {
    // Depend on common module
    implementation project(':common')

    // Spigot API
    compileOnly spigot('1.21.8')
}

spigot {
    apiVersion = '1.21'
    depends = ['Vault']

    commands {
        register('mycommand') {
            description = 'My command'
        }
    }
}

// Shadow common module into final JAR
tasks.shadowJar {
    archiveClassifier = ''
    from project(':common').sourceSets.main.output
}

// Make jar task depend on common module
tasks.jar {
    dependsOn(':common:jar')
    from project(':common').sourceSets.main.output
}
```

</details>

<details>
<summary>Kotlin DSL</summary>

```kotlin
import io.typst.spigradle.spigot.*

plugins {
    id("io.typst.spigradle") version "3.5.0"
}

repositories {
    spigotmc()
    papermc()
}

dependencies {
    // Depend on common module
    implementation(project(":common"))

    // Spigot API
    compileOnly(spigot("1.21.8"))
}

spigot {
    apiVersion = "1.21"
    depends = listOf("Vault")

    commands {
        register("mycommand") {
            description = "My command"
        }
    }
}

// Shadow common module into final JAR
tasks.shadowJar {
    archiveClassifier.set("")
    from(project(":common").sourceSets.main.get().output)
}

// Make jar task depend on common module
tasks.jar {
    dependsOn(":common:jar")
    from(project(":common").sourceSets.main.get().output)
}
```

</details>

#### BungeeCord module (bungee/build.gradle)

<details>
<summary>Groovy DSL</summary>

```groovy
plugins {
    id 'io.typst.spigradle.bungee' version '3.5.0'
}

dependencies {
    // Depend on common module
    implementation project(':common')

    // BungeeCord API
    compileOnly bungeecord('1.21')
}

bungee {
    author = 'YourName'
    depends = ['SomePlugin']
}

// Shadow common module into final JAR
tasks.jar {
    dependsOn(':common:jar')
    from project(':common').sourceSets.main.output
}
```

</details>

<details>
<summary>Kotlin DSL</summary>

```kotlin
import io.typst.spigradle.bungee.*

plugins {
    id("io.typst.spigradle.bungee") version "3.5.0"
}

dependencies {
    // Depend on common module
    implementation(project(":common"))

    // BungeeCord API
    compileOnly(bungeecord("1.21"))
}

bungee {
    author = "YourName"
    depends = listOf("SomePlugin")
}

// Shadow common module into final JAR
tasks.jar {
    dependsOn(":common:jar")
    from(project(":common").sourceSets.main.get().output)
}
```

</details>

## Common Patterns

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

### Common/Shared Module

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

The common module typically contains:
- Business logic independent of platform
- Data models and DTOs
- Utility classes
- Configuration handling
- Database access layer
- API interfaces

**Key characteristics:**
- No Spigradle plugin applied
- No platform-specific dependencies (Spigot, BungeeCord APIs)
- Can use libraries like Gson, databases, etc.

**Example structure:**
```
common/
└── src/main/java/com/example/myplugin/
    ├── config/
    │   └── PluginConfig.java
    ├── model/
    │   └── PlayerData.java
    ├── service/
    │   └── DataService.java
    └── util/
        └── MessageFormatter.java
```

### Platform-Specific Modules

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Each platform module contains:
- Platform-specific entry point (extends JavaPlugin/Plugin/PluginBase)
- Platform API integrations
- Event listeners
- Command implementations
- Platform-specific utilities

**Example Spigot module:**
```
spigot/
└── src/main/java/com/example/myplugin/spigot/
    ├── MySpigotPlugin.java      # extends JavaPlugin
    ├── listeners/
    │   └── PlayerJoinListener.java
    └── commands/
        └── MyCommand.java
```

**Example BungeeCord module:**
```
bungee/
└── src/main/java/com/example/myplugin/bungee/
    ├── MyBungeePlugin.java      # extends Plugin
    └── listeners/
        └── ServerConnectListener.java
```

### API Module

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

For plugins that expose a public API for other developers:

```groovy
// api/build.gradle
dependencies {
    // API typically doesn't depend on implementation
    compileOnly spigot('1.21.8')  // Only if needed
}
```

Other modules depend on the API:
```groovy
// spigot/build.gradle
dependencies {
    api project(':api')           // Expose API to consumers
    implementation project(':common')  // Hide implementation
}
```

## Complete Examples

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

### Cross-Platform Plugin Example

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

A complete example of a plugin that works on both Spigot and BungeeCord:

**Project structure:**
```
my-plugin/
├── settings.gradle
├── build.gradle
├── common/
│   ├── build.gradle
│   └── src/main/java/com/example/
│       ├── MyPluginConfig.java
│       └── MessageService.java
├── spigot/
│   ├── build.gradle
│   └── src/main/java/com/example/spigot/
│       ├── MySpigotPlugin.java
│       └── listeners/PlayerListener.java
└── bungee/
    ├── build.gradle
    └── src/main/java/com/example/bungee/
        ├── MyBungeePlugin.java
        └── listeners/ProxyListener.java
```

**Common module code:**
```java
// common/src/main/java/com/example/MessageService.java
package com.example;

public class MessageService {
    public String formatMessage(String player, String message) {
        return "[MyPlugin] " + player + ": " + message;
    }
}
```

**Spigot module code:**
```java
// spigot/src/main/java/com/example/spigot/MySpigotPlugin.java
package com.example.spigot;

import com.example.MessageService;
import org.bukkit.plugin.java.JavaPlugin;

public class MySpigotPlugin extends JavaPlugin {
    private MessageService messageService;

    @Override
    public void onEnable() {
        messageService = new MessageService();
        getLogger().info("Spigot plugin enabled!");
    }
}
```

**BungeeCord module code:**
```java
// bungee/src/main/java/com/example/bungee/MyBungeePlugin.java
package com.example.bungee;

import com.example.MessageService;
import net.md_5.bungee.api.plugin.Plugin;

public class MyBungeePlugin extends Plugin {
    private MessageService messageService;

    @Override
    public void onEnable() {
        messageService = new MessageService();
        getLogger().info("BungeeCord plugin enabled!");
    }
}
```

### Using buildSrc for Shared Configuration

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

For complex multi-module projects, use `buildSrc` to share build logic:

**Project structure:**
```
my-plugin/
├── buildSrc/
│   └── src/main/kotlin/
│       └── common-conventions.gradle.kts
├── settings.gradle
└── ...modules...
```

**buildSrc/src/main/kotlin/common-conventions.gradle.kts:**
```kotlin
plugins {
    java
}

group = "com.example.myplugin"
version = "1.0.0"

repositories {
    mavenCentral()
}

java {
    toolchain {
        languageVersion.set(JavaLanguageVersion.of(17))
    }
}
```

**Usage in modules:**
```kotlin
// spigot/build.gradle.kts
plugins {
    id("common-conventions")
    id("io.typst.spigradle") version "3.5.0"
}
```

## Dependency Management

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

### Inter-Module Dependencies

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

**Using `implementation`:**
```groovy
// Hides the dependency from consumers
implementation project(':common')
```

**Using `api`:**
```groovy
// Exposes the dependency to consumers (requires java-library plugin)
api project(':api')
```

### Platform Dependencies

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Each platform module should declare its own dependencies:

```groovy
// spigot/build.gradle
dependencies {
    implementation project(':common')
    compileOnly spigot('1.21.8')
    implementation 'com.google.code.gson:gson:2.10.1'
}

// bungee/build.gradle
dependencies {
    implementation project(':common')
    compileOnly bungeecord('1.21')
    implementation 'com.google.code.gson:gson:2.10.1'
}
```

**Tip:** Use `gradle.properties` to manage common dependency versions:

```properties
# gradle.properties

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)
gsonVersion=2.10.1
spigotVersion=1.21.8
```

```groovy
// In build.gradle
dependencies {
    implementation "com.google.code.gson:gson:${gsonVersion}"
}
```

### Shadowing Dependencies

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

When using Shadow plugin to bundle dependencies:

```groovy
// spigot/build.gradle
plugins {
    id 'com.github.johnrengelman.shadow' version '8.1.1'
    id 'io.typst.spigradle'
}

shadowJar {
    // Relocate to avoid conflicts
    relocate 'com.google.gson', 'com.example.myplugin.lib.gson'

    // Include common module
    from project(':common').sourceSets.main.output

    archiveClassifier = ''
}

build {
    dependsOn shadowJar
}
```

## Building Multi-Module Projects

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

### Build All Modules

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

```bash
# Build all modules

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)
./gradlew build

# Build specific module

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)
./gradlew :spigot:build

# Clean and build

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)
./gradlew clean build
```

### Build Order

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Gradle automatically handles build order based on dependencies:
1. `common` module builds first
2. `spigot` and `bungee` build after (since they depend on `common`)

### Artifacts Location

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Built JARs are located in each module's `build/libs/` directory:
```
my-plugin/
├── common/build/libs/common-1.0.0.jar
├── spigot/build/libs/spigot-1.0.0.jar
└── bungee/build/libs/bungee-1.0.0.jar
```

### Distribution

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

For distribution, you typically only need platform-specific JARs:
- `spigot-1.0.0.jar` (includes common code)
- `bungee-1.0.0.jar` (includes common code)

The `common-1.0.0.jar` is an intermediate artifact not needed for distribution.

## Best Practices

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

### 1. Keep Common Module Platform-Agnostic

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

**Good:**
```java
// common module
public interface MessageSender {
    void sendMessage(UUID playerId, String message);
}
```

**Bad:**
```java
// common module - DON'T DO THIS
import org.bukkit.entity.Player; // Platform-specific!

public class MessageService {
    public void send(Player player, String msg) { }
}
```

### 2. Use Dependency Injection

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Avoid static dependencies between modules:

**Good:**
```java
// Spigot module
public class MySpigotPlugin extends JavaPlugin {
    private final MessageService messageService;

    public MySpigotPlugin() {
        this.messageService = new MessageService(new SpigotMessageSender());
    }
}
```

**Bad:**
```java
// Using static references
MessageService.getInstance().send(...);
```

### 3. Version Consistency

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Keep all modules at the same version:

```groovy
// root build.gradle
subprojects {
    version = '1.0.0'  // Same for all
}
```

### 4. Shared Resources

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

For shared resources (like messages, configs), include them in the common module and copy to platform modules:

```groovy
// spigot/build.gradle
processResources {
    from(project(':common').sourceSets.main.resources)
}
```

### 5. Main Class Detection

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Spigradle's main class detection works independently in each platform module:
- `spigot` module: Detects class extending `JavaPlugin`
- `bungee` module: Detects class extending `Plugin`
- `common` module: No main class needed

### 6. Separate Test Dependencies

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Each module can have its own test dependencies:

```groovy
// spigot/build.gradle
dependencies {
    testImplementation 'org.mockito:mockito-core:5.8.0'
    testImplementation project(':common')
}

// common/build.gradle
dependencies {
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.1'
}
```

## Troubleshooting

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

### Issue: "Could not find project :common"

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

**Cause:** Module not declared in `settings.gradle`

**Solution:**
```groovy
// settings.gradle
include 'common'
include 'spigot'
```

### Issue: Circular dependencies

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

**Cause:** Module A depends on Module B, and Module B depends on Module A

**Solution:** Restructure your modules to have a clear dependency hierarchy:
```
api → common → spigot/bungee
```

### Issue: Main class not detected in platform module

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

**Cause:** Main class might be in common module instead of platform module

**Solution:** Ensure your JavaPlugin/Plugin class is in the platform-specific module:
```
✓ spigot/src/.../MySpigotPlugin.java extends JavaPlugin
✗ common/src/.../MyPlugin.java extends JavaPlugin
```

### Issue: NoClassDefFoundError for common classes

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

**Cause:** Common module classes not included in final JAR

**Solution:** Add common module output to JAR:
```groovy
tasks.jar {
    from project(':common').sourceSets.main.output
}
```

Or use Shadow plugin to bundle:
```groovy
shadowJar {
    from project(':common').sourceSets.main.output
}
```

### Issue: Duplicate files in JAR

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

**Cause:** Multiple modules contribute the same resource files

**Solution:** Use `duplicatesStrategy`:
```groovy
tasks.jar {
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    from project(':common').sourceSets.main.output
}
```

### Issue: Different Java versions between modules

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

**Cause:** Inconsistent Java toolchain configuration

**Solution:** Configure in root `build.gradle`:
```groovy
subprojects {
    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(17)
        }
    }
}
```

## See also

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

- [The Spigot plugin](spigot_plugin.md)
- [The Bungeecord plugin](bungeecord_plugin.md)
- [The Nukkit plugin](nukkit_plugin.md)
- [README.md](../README.md)
- [Gradle Multi-Project Builds](https://docs.gradle.org/current/userguide/multi_project_builds.html)
- [Gradle Java Library Plugin](https://docs.gradle.org/current/userguide/java_library_plugin.html)
- [Shadow Plugin](https://github.com/johnrengelman/shadow)
