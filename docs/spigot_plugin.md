# Spigot plugin

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

kdoc(javadoc): [SpigotPlugin.kt](https://docs.typst.io/spigradle/3.7.1/spigradle/io.typst.spigradle.spigot/-spigot-plugin/index.html)

The [Spigot](https://www.spigotmc.org/wiki/about-spigot/) plugin provides the following features:

- Generate 'plugin.yml' with the main detected automatically

- Debug feature: task `debug$ProjectName`, idea Run Configuration `Debug$ProjectName`/`Run$ProjectName`

- Shortcuts for [dependency](../README.md#dependencies) and [repository](../README.md#repositories).

## Table of contents

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

- [Requirements](#requirements)

- [Usage](#usage)

- [Description file generation](#description-file-generation)

- [Main class detection](#main-class-detection)

- [Configuration](#configuration)

- [Tasks](#tasks)

- [Why not spigot-annotations?](#why-not-spigot-annotations)

- [Testing with MockBukkit](#testing-with-mockbukkit)

- [Migration Tips](#migration-tips)

- [Templates](#templates)

- [See also](#see-also)

## Requirements

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

The plugin requires Gradle 8.0+, the latest version is recommended.

To update your gradle wrapper:

```
gradlew wrapper --gradle-version 8.14.3 --distribution-type all
```

## Usage

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

[Full Example Here](https://github.com/spigradle/spigradle-sample/tree/master/spigot)

Groovy DSL

```groovy
plugins {
    id 'io.typst.spigradle' version '3.7.1'
}
```

Kotlin DSL

```kotlin
plugins {
    id("io.typst.spigradle") version "3.7.1"
}
```

<details>
<summary>Groovy Legacy</summary>

```groovy
buildscript {
    repositories {
        gradlePluginPortal()
    }
    dependencies {
        classpath 'io.typst:spigradle:3.7.1'
    }
}

apply plugin: 'io.typst.spigradle'
```

</details>

<details>
<summary>Kotlin Legacy</summary>

```groovy
buildscript {
    repositories {
        gradlePluginPortal()
    }
    dependencies {
        classpath("io.typst:spigradle:3.7.1")
    }
}

apply(plugin = "io.typst.spigradle")
```

</details>

## Description file generation

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

The `plugin.yml` file will be generated by task `generateSpigotDescription` based on the [configuration of
`spigot`](#configuration), included into output jars automatically.

Basically the properties 'main', 'name' and 'version' defaults
to [auto-detected main](#main-class-detection), [project.name](https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html#getName--), [project.version](https://docs.gradle.org/current/javadoc/org/gradle/api/Project.html#getName--)
respectively. So if we create a simple plugin that just needs those properties, we don't need any configuration. Only
pay attention to your unique implementation.

You can configure all properties of `plugin.yml` in [spigot {} block](#configuration).

## Main class detection

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

The plugin automatically detects your main plugin class using bytecode analysis (ASM). It scans compiled `.class` files to find classes that extend [JavaPlugin](https://hub.spigotmc.org/javadocs/bukkit/org/bukkit/plugin/java/JavaPlugin.html).

**How it works:**
- Scans compiled bytecode (not source code) for faster and more reliable detection
- Finds non-abstract, public classes extending `org.bukkit.plugin.java.JavaPlugin`
- Supports complex inheritance hierarchies
- Incremental: only scans changed files for faster builds
- Automatically sets the `main` property in `plugin.yml`

**Manual override:**
If you need to manually specify the main class:
```groovy
spigot {
    main.set("com.example.MyCustomMain")
}
```

For more details, see the [Main Class Detection](../README.md#main-class-detection) section.

## Configuration

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

### spigot extension - [SpigotExtension](https://docs.typst.io/spigradle/3.7.1/spigradle/io.typst.spigradle.spigot/-spigot-extension/index.html)

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

The description of your plugin for a `plugin.yml`.

The 'main' property will be set to the class [auto-detected](#main-class-detection)

About the `plugin.yml`, See [plugin-yml wiki](https://www.spigotmc.org/wiki/plugin-yml/)

<details>
<summary>Groovy Example</summary>

```groovy
spigot {
    authors 'Me'
    depends 'ProtocolLib', 'Vault'
    softDepends 'WorldEdit'
    apiVersion '1.15'
    load STARTUP
    libraries = ['my:lib:1.0.0', 'my:lib2:1.0.0']
    commands {
        register('give') {
            aliases 'giv', 'i'
            description 'Give command.'
            permission 'test.foo'
            permissionMessage 'You do not have the permission!'
            usage '/<command> [item] [amount]'
        }
    }
    permissions {
        register('test.foo') {
            description 'Allows foo command'
            defaults 'true'
        }
        register('test.*') {
            description 'Wildcard permission'
            defaults 'op'
            children = ['test.foo': true]
        }
    }
}
```

</details>

<details>
<summary>Kotlin Example</summary>

```kotlin
spigot {
    authors = listOf("Me")
    depends = listOf("ProtocolLib")
    softDepends = listOf("WorldEdit")
    apiVersion = "1.15"
    load = Load.STARTUP
    commands {
        register("give") {
            aliases = listOf("i")
            description = "Give command."
            permission = "test.foo"
            permissionMessage = "You do not have permission!"
            usage = "/<command> [test|stop]"
        }
    }
    permissions {
        register("test.foo") {
            description = "Allows foo command"
            defaults = "true"
        }
        register("test.*") {
            description = "Wildcard permission"
            defaults = "op"
            children = mapOf("test.foo" to true)
        }
    }
}
```

Without [type-safe accessors](https://docs.gradle.org/current/userguide/kotlin_dsl.html#sec:kotlin_using_standard_api):

```kotlin
configure<SpigotExtension> {
    authors = listOf("Me")
    // ...
}
```

</details>

### debugSpigot extension - [DebugExtension](https://docs.typst.io/spigradle/3.7.1/spigradle/io.typst.spigradle.debug/-debug-extension/index.html)

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

> **Note:** `debugSpigot` is a configuration extension, NOT a task. The actual task is named `debug${ProjectName}` (e.g., `debugMyPlugin`).

```groovy
debugSpigot {
    // This extension configures the debug${ProjectName} task
    // and IDEA Run configurations: Debug${ProjectName}, Run${ProjectName}
    version.set("1.21.8")
    eula.set(true)
    // if you want to specify the port(default 5005):
    // jvmDebugPort.set(int)
}
```

## Tasks

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

All tasks
supports [UP-TO-DATE check](https://docs.gradle.org/current/userguide/more_about_tasks.html#sec:up_to_date_checks).

### detectSpigotMain - [SubclassDetection](https://docs.typst.io/spigradle/3.7.1/spigradle/io.typst.spigradle/-subclass-detection/index.html)

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

Finds the main class
extends [org.bukkit.plugin.java.JavaPlugin](https://hub.spigotmc.org/javadocs/bukkit/org/bukkit/plugin/java/JavaPlugin.html).

### generateSpigotDescription - [YamlGenerate](https://docs.typst.io/spigradle/3.7.1/spigradle/io.typst.spigradle/-yaml-generate/index.html)

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

*Depends on: `detectSpigotMain`*

Generates the description file 'plugin.yml'.

### `debug${ProjectName}` - [Exec](https://docs.gradle.org/current/javadoc/org/gradle/api/DefaultTask.html)

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

*Depends on: `downloadPaper`, `preparePluginDependencies`, `createJavaDebugScript`*

Runs a local Paper server with your plugin for debugging. This task orchestrates the complete debug workflow:

**What it does:**

1. **Downloads Paper server** (via `downloadPaper`) - Fetches the specified Paper version from PaperMC API if not already cached
2. **Prepares plugin dependencies** (via `preparePluginDependencies`) - Resolves plugins listed in `depends`/`softDepends`:
  - First tries to copy from your project's `compileClasspath`
  - Falls back to downloading from SpigotMC (via Spiget API) if not found
3. **Copies your plugin JAR** (via `copyArtifactJar`) - Copies the built plugin to the debug server's plugins folder
4. **Creates starter scripts** (via `createJavaDebugScript`) - Generates platform-specific scripts:
  - `starter.bat` for Windows
  - `starter` for Unix/Linux/Mac
5. **Launches the server** - Opens a new terminal window and runs the server

**IntelliJ IDEA Run Configurations:**

Spigradle automatically creates two run configurations:

1. **`Debug${ProjectName}` - Remote JVM Debug** ‚≠ê **Recommended**
   - **Type:** Remote JVM Debug configuration
   - **Purpose:** Attaches debugger to an already-running server process
   - **Recommended workflow:**
     1. Run `debug${ProjectName}` task via IntelliJ's terminal or "Run Gradle Task"
     2. Server starts in a new terminal window with remote debugging enabled on port 5005
     3. Click the "üêû Debug" button on this configuration to attach the debugger
   - **Advantages:**
     - **Keeps IntelliJ lightweight** - server runs in separate terminal, not managed by IDE
     - Clean separation between server output and IDE
     - Better performance - IDE doesn't handle server I/O
   - **When to use:** Standard debugging workflow (recommended for regular use)

2. **`Run${ProjectName}` - JarApplication**
   - **Type:** JarApplication run configuration
   - **Purpose:** All-in-one server launch directly from IntelliJ
   - **Usage:**
     - Click the "‚ñ∂ Run" button to start the server normally
     - Click the "üêû Debug" button to start the server AND attach debugger in one step
   - **Note:** Makes IntelliJ heavier as it manages the server process directly; You need to click the `Sync All Gradle Projects` button in IDEA if you change the debugSpigot extension.
   - **When to use:** Only when you want absolute convenience and don't mind the performance impact

**Directory structure:**

- Server directory: `MY_PROJECT/.gradle/spigradle-debug/paper/`
- Global JAR cache: `GRADLE_USER_HOME/spigradle-debug-jars/paper/VERSION/paper.jar`
- Plugin dependencies: `MY_PROJECT/.gradle/spigradle-debug/paper/plugins/`

**Configuration:**

See [debugSpigot extension](#debugspigot-extension---debugextension) for configuration options like version, EULA acceptance, JVM arguments, and debug port.

## Why not spigot-annotations?

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

```kotlin
@Plugin(name = "SamplePlugin", version = "1.0-SNAPSHOT")
@Commands(
    @Command(
        name = "foo",
        desc = "Foo command",
        aliases = ["foobar", "fubar"],
        permission = "test.foo",
        permissionMessage = "You do not have permission!",
        usage = "/<command> [test|stop]"
    )
)
@Permission(name = "test.foo", desc = "Allows foo command", defaultValue = PermissionDefault.OP)
class SamplePlugin : JavaPlugin()
```

If you use Gradle, the following reasons why
no [spigot-annotations](https://hub.spigotmc.org/stash/projects/SPIGOT/repos/plugin-annotations/browse):

1. Duplicate information of the `name` and `version`, these already provided in `build.gradle` and `settings.gradle`.
2. The Annotation doesn't suit for providing complex information like `commands` and `permissions`.
3. Using Gradle, we can configure all things programmatically.

Replacement on build.gradle:

```groovy
spigot {
    // The 'name' and 'version' will be set to project.version and project.name,
    // But we may set those manually for the example
    name.set('Manual name')
    version.set('Manual version')
    commands {
        register('foo') {
            aliases = ['foobar', 'fubar']
            description = 'Foo command'
            permission = 'test.foo'
            permissionMessage = 'You do not have permission!'
            usage = '/<command> [test|stop]'
        }
    }
    permissions {
        register('test.foo') {
            description = 'Allows foo command'
            defaults = 'op'
        }
    }
}
```

## Testing with MockBukkit

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

With Spigradle 1.3.0+, you can use the [MockBukkit](https://github.com/seeseemelk/MockBukkit) without any special code.

If you use less than 1.3.0, add it in build.gradle:

```groovy
task copyPluginYaml(type: Copy, dependsOn: spigotPluginYaml) {
    from(new File(spigotPluginYaml.temporaryDir, 'plugin.yml'))
    into(sourceSets.test.output.resourcesDir)
}

tasks.test.dependsOn(copyPluginYaml)
```

## Migration Tips

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

### 3.x <- 2.x

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

- The groupId has been changed from `kr.entree.spigradle` to `io.typst.spigradle`.
- No more implicit repo/dep: need to declare repository(spigotmc)
- No more @Plugin annotation: the main class will be detected automatically.
- The Gradle version must be 8.x or higher (ex: 8.14.3)
  - If you use gradle wrapper, edit the `distributionUrl` in `gradle/wrapper/gradle-wrapper.properties` ex)
    `gradle-8.14.3-all.zip`
- The Gradle JVM version must be 17 or higher.
- The options `main`, `name`, `version`, `description` are changed type Property<String> from String
  - Configuration example: `spigot { description.set("my description") }`

![img.png](./../assets/idea-gradle-jvm.png)

### 2.x <- 1.x

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

- The task `spigotPluginYaml` renamed to `generateSpigotDescription`
- The annotation `@Plugin` repackaged to `@io.typst.spigradle.annotations.Plugin`.

## Templates

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

[spigot-plugin-template](https://github.com/Silthus/spigot-plugin-template) by @Silthus

[BukkitJavaGradle](https://github.com/PluginTemplates/BukkitJavaGradle) by @portlek

## See also

[comment]: <> (!! Do not edit this file but 'docs/templates' or 'docs/root-templates', See [CONTRIBUTING.md] !!)

- [The Bungeecord plugin](bungeecord_plugin.md)
- [The Nukkit plugin](nukkit_plugin.md)
- [README.md](../README.md)
- [Gradle Kotlin DSL Primer](https://docs.gradle.org/current/userguide/kotlin_dsl.html)
